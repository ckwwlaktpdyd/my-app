'use strict';

var fs = require('fs');
var J = require('glob');
var A = require('path');
var O = require('postcss');
var D = require('postcss-scss');
var jsdom = require('jsdom');

function _interopDefault (e) { return e && e.__esModule ? e : { default: e }; }

var J__default = /*#__PURE__*/_interopDefault(J);
var A__default = /*#__PURE__*/_interopDefault(A);
var O__default = /*#__PURE__*/_interopDefault(O);
var D__default = /*#__PURE__*/_interopDefault(D);

var k=(t=>typeof require<"u"?require:typeof Proxy<"u"?new Proxy(t,{get:(e,i)=>(typeof require<"u"?require:e)[i]}):t)(function(t){if(typeof require<"u")return require.apply(this,arguments);throw new Error('Dynamic require of "'+t+'" is not supported')});var g=(l=>(l.ANIMATION="Animation",l.BORDER="Border",l.BORDER_RADIUS="BorderRadius",l.COLOR="Color",l.EASING="Easing",l.FONT_FAMILY="FontFamily",l.FONT_SIZE="FontSize",l.FONT_WEIGHT="FontWeight",l.GRADIENT="Gradient",l.LINE_HEIGHT="LineHeight",l.LETTER_SPACING="LetterSpacing",l.OPACITY="Opacity",l.SHADOW="Shadow",l.SPACING="Spacing",l.SVG="Svg",l.IMAGE="Image",l))(g||{});async function T(t=[]){let e=G(t);return {categories:e.map(s=>s.categoryName).filter((s,r,a)=>a.indexOf(s)===r).map(s=>({name:s||"Images",presenter:"Image",tokens:e.filter(r=>r.categoryName===s)}))}}function G(t){return t?t.map(e=>{let i=A.relative(process.cwd(),e.filename);return {name:A.basename(e.filename,A.extname(e.filename)),description:i,categoryName:"Images",presenter:"Image",rawValue:i,sourceType:"IMAGE",value:N(e.filename)}}).filter(e=>e.name):[]}function N(t){let e=fs.readFileSync(t);return Buffer.from(e).toString("base64")}async function f(t=[],e,i){let s=t.filter((n,c,m)=>n.content&&!m.some((u,p)=>u.content===n.content&&p<c)),r=await _(s.filter(n=>n.content)),a=R(r.comments,r.declarations,e),o=r?.keyframes.map(n=>n.toString()).join(" ");return i&&(o=o+`:root {
        ${r.declarations.map(n=>n.toString()).join(";")}
      }`),{categories:a,injectionStyles:o}}function R(t,e,i){let s=t.filter(r=>r.text.includes("@tokens ")||r.text.includes("@tokens-end"));return s.map((r,a)=>{if(r.text.includes("@tokens-end"))return;let o=s[a+1],n=r.source?.input.file!==o?.source?.input.file,c=/@tokens (.+)/g.exec(r.text),u=/@presenter (.+)/g.exec(r.text)?.[1];if(u&&!Object.values(g).includes(u||""))throw new Error(`Presenter "${u}" is not valid.`);let p={from:{column:r.source?.start?.column||0,line:r.source?.start?.line||0},to:!n&&o?.prev()?{column:o.prev()?.source?.end?.column||0,line:o.prev()?.source?.end?.line||0}:!n&&o?{column:o.source?.start?.column||0,line:o.source?.start?.line||0}:void 0},d=r.source?.input.from||"";return {name:c?.[1]||"",presenter:u,range:p,source:d,tokens:P(d,p,e,t,i,u)}}).filter(L)}function P(t,e,i,s,r,a){return i.filter(n=>n.source?.input.from===t&&(n.source?.start?.line||-1)>e.from.line&&(!e.to||(n.source?.start?.line||-1)<=e.to.line)).map(n=>{let c=s.find(p=>p.source?.input.file===n.source?.input.file&&p.source?.start?.line===n.source?.end?.line),m=W(n.value,i),u;if(c){let p=/@presenter (.+)/g.exec(c.text);p&&(u=p[1],c.text=c.text.replace(p[0]||"",""));}return {description:c?.text,isAlias:m!==n.value,name:n.prop,presenter:u||a,rawValue:n.value,sourceType:r,value:m,sourcePath:n.source?.input.from||""}}).slice().reverse().filter((n,c,m)=>c===m.findIndex(u=>u.name===n.name)).reverse()}function W(t,e){t=t.replace(/!default/g,"").replace(/!global/g,"");let i=/\bvar\(([^)]+)\)|(\$[a-zA-Z0-9-_]+|@[a-zA-Z0-9-_]+)/g,s,r=t;for(;(s=i.exec(t))!==null;){let a=s[0],o=a.replace(/\(|\)|var\(|@|\$/g,""),n=e.find(c=>c.prop===o||c.prop===`$${o}`||c.prop===`@${o}`)?.value||"";r=r.replace(a,n);}return r}async function _(t){let e=[],i=[],s=[],r={postcssPlugin:"storybook-design-token-parser",Once(a){a.walkAtRules(o=>{if(o.name==="keyframes"){s.push(o);return}let n=o;n.name.endsWith(":")&&i.push({...n,prop:`@${n.name.substr(0,n.name.length-1)}`,value:n.params});}),a.walkComments(o=>{e.push(o);}),a.walkDecls(o=>{(o.prop.startsWith("--")||o.prop.startsWith("$"))&&i.push(o);});}};return await Promise.all(t.map(a=>{let o=a.filename.endsWith(".scss")||a.filename.endsWith(".less")?D__default.default:void 0;return O__default.default([r]).process(a.content,{from:a.filename,syntax:o})})),{comments:e,declarations:i,keyframes:s}}function L(t){return !!t&&t.hasOwnProperty("presenter")}async function h(t=[]){let e=H(t);return {categories:e.map(s=>s.categoryName).filter((s,r,a)=>a.indexOf(s)===r).map(s=>({name:s||"SVG Icons",presenter:"Svg",tokens:e.filter(r=>r.categoryName===s)}))}}function H(t){if(!t)return [];let{document:e}=new jsdom.JSDOM().window;return t.map(i=>{let s=e.createElement("div");s.innerHTML=i.content;let r=Array.from(s.querySelectorAll("svg")),a=A.basename(i.filename,A.extname(i.filename));return r.map((o,n,c)=>({name:o?.getAttribute("data-token-name")||o?.getAttribute("id")||(c.length>1?`${a}-${n+1}`:a),description:o?.getAttribute("data-token-description")||"",categoryName:o?.getAttribute("data-token-category")||"SVG Icons",presenter:"Svg",rawValue:o.outerHTML,sourceType:"SVG",value:o.outerHTML})).filter(o=>o.name)}).flat()}function x(t,e){let i=A__default.default.join(t,e||process.env.DESIGN_TOKEN_GLOB||"**/*.{css,scss,less,svg,png,jpeg,gif}").replace(/\\/g,"/");return J__default.default.sync(i,{ignore:["**/node_modules/**","**/storybook-static/**","**/*.chunk.*"]})}function q(t,e){t.fileDependencies.addAll(e);}async function C(t){let e=t.map(n=>({filename:n,content:fs.readFileSync(n,"utf-8")})).filter(n=>n.content.includes("@tokens")||n.filename.endsWith(".svg")||b(n.filename)),i=await f(e.filter(n=>n.filename.endsWith(".css")),"CSS",!0),s=await f(e.filter(n=>n.filename.endsWith(".scss")),"SCSS",!0),r=await f(e.filter(n=>n.filename.endsWith(".less")),"Less",!0),a=await h(e.filter(n=>n.filename.endsWith(".svg"))),o=await T(e.filter(n=>b(n.filename)));return JSON.stringify({cssTokens:i,scssTokens:s,lessTokens:r,svgTokens:a,imageTokens:o})}var y=class{constructor(e){this.designTokenGlob=e;}apply(e){e.hooks.initialize.tap("StorybookDesignTokenPlugin",()=>{let i=x(e.context,this.designTokenGlob);e.hooks.emit.tap("StorybookDesignTokenPlugin",s=>{q(s,i);}),e.hooks.thisCompilation.tap("StorybookDesignTokenPlugin",s=>{s.hooks.processAssets.tapAsync({name:"HtmlWebpackPlugin",stage:e.webpack.Compilation.PROCESS_ASSETS_STAGE_OPTIMIZE_INLINE},async(r,a)=>{let o=await C(i);r["design-tokens.source.json"]={source:()=>o,size:()=>o.length},a();});});});}};function v(t){let e,s;return {name:"vite-storybook-design-token-plugin",configResolved(r){e=r.publicDir,r.root;},transform:async function(){if(!e)return;s=x("./",t?.designTokenGlob).map(a=>`./${a}`);let r=await C(s);fs.existsSync(e)||fs.mkdirSync(e),fs.writeFileSync(A__default.default.join(e,"design-tokens.source.json"),r);}}}function b(t){return t.endsWith(".jpeg")||t.endsWith(".png")||t.endsWith(".gif")}function Fe(t=[]){return [...t,k.resolve("./manager")]}var Ee=async(t,e)=>(t.plugins=t.plugins||[],t.plugins.push(v(e)),t);async function Ie(t,{designTokenGlob:e,presets:i}){if(await i.apply("webpackVersion")>=5)t.plugins.push(new y(e));else throw Error("Webpack 4 is not supported by the storybook-design-token addon.");return t}

exports.managerEntries = Fe;
exports.viteFinal = Ee;
exports.webpackFinal = Ie;
//# sourceMappingURL=out.js.map
//# sourceMappingURL=preset.js.map