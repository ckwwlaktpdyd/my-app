# GitHub Actions ì›Œí¬í”Œë¡œìš°: Storybookê³¼ Figma ì—°ë™ ìë™í™”
# ì´ ì›Œí¬í”Œë¡œìš°ëŠ” ì½”ë“œ ë³€ê²½ ì‹œ ìë™ìœ¼ë¡œ Storybookì„ ë¹Œë“œí•˜ê³  Chromaticì— ë°°í¬í•©ë‹ˆë‹¤.

name: 'Chromatic Deployment'

# ì–¸ì œ ì´ ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰ë ì§€ ì •ì˜
on:
  # ë©”ì¸ ë¸Œëœì¹˜ì— í‘¸ì‹œí•  ë•Œ
  push:
    branches: [ main, develop ]
  # Pull Requestê°€ ìƒì„±ë˜ê±°ë‚˜ ì—…ë°ì´íŠ¸ë  ë•Œ
  pull_request:
    branches: [ main ]

# ì›Œí¬í”Œë¡œìš°ê°€ ì‹¤í–‰í•  ì‘ì—…ë“¤
jobs:
  chromatic-deployment:
    # Ubuntu ìµœì‹  ë²„ì „ì—ì„œ ì‹¤í–‰
    runs-on: ubuntu-latest
    
    steps:
      # 1ë‹¨ê³„: ì €ì¥ì†Œ ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          # Chromaticì—ì„œ ë³€ê²½ì‚¬í•­ì„ ì •í™•íˆ ê°ì§€í•˜ê¸° ìœ„í•´ ì „ì²´ íˆìŠ¤í† ë¦¬ ê°€ì ¸ì˜¤ê¸°
          fetch-depth: 0

      # 2ë‹¨ê³„: Node.js í™˜ê²½ ì„¤ì •
      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      # 3ë‹¨ê³„: ì˜ì¡´ì„± ì„¤ì¹˜
      - name: ğŸ“¥ Install dependencies
        run: npm ci

      # 4ë‹¨ê³„: Storybook ë¹Œë“œ ë° Chromaticì— ë°°í¬
      - name: ğŸš€ Publish to Chromatic
        uses: chromaui/action@latest
        with:
          # Chromatic í”„ë¡œì íŠ¸ í† í° (GitHub Secretsì—ì„œ ê°€ì ¸ì˜´)
          projectToken: ${{ secrets.CHROMATIC_PROJECT_TOKEN }}
          # ë¹Œë“œê°€ ì—…ë¡œë“œë˜ë©´ ì¦‰ì‹œ ì¢…ë£Œ (CI ì†ë„ í–¥ìƒ)
          exitOnceUploaded: true
          # ìë™ìœ¼ë¡œ ë³€ê²½ì‚¬í•­ ìŠ¹ì¸ (ì„ íƒì‚¬í•­)
          autoAcceptChanges: true
          # ë¹Œë“œ ê²°ê³¼ë¥¼ GitHub PRì— ëŒ“ê¸€ë¡œ ì¶”ê°€
          exitZeroOnChanges: true

      # 5ë‹¨ê³„: Storybook ì •ì  ë¹Œë“œ (GitHub Pages ë°°í¬ìš©)
      - name: ğŸ—ï¸ Build Storybook
        run: npm run build-storybook

      # 6ë‹¨ê³„: GitHub Pagesì— Storybook ë°°í¬
      - name: ğŸŒ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        if: github.ref == 'refs/heads/main'
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./storybook-static
          # ì»¤ìŠ¤í…€ ë„ë©”ì¸ ì„¤ì • (ì„ íƒì‚¬í•­)
          # cname: your-storybook-domain.com

  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì‘ì—…
  quality-checks:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¥ Install dependencies
        run: npm ci

      # ë¦°í„° ì‹¤í–‰ (ESLintê°€ ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´)
      - name: ğŸ” Run linter
        run: npm run lint || echo "No lint script found"
        continue-on-error: true

      # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (Jestë‚˜ ë‹¤ë¥¸ í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ê°€ ì„¤ì •ë˜ì–´ ìˆë‹¤ë©´)
      - name: ğŸ§ª Run tests
        run: npm test || echo "No test script found"
        continue-on-error: true

      # Storybook ë¹Œë“œ í…ŒìŠ¤íŠ¸
      - name: ğŸ—ï¸ Test Storybook build
        run: npm run build-storybook
